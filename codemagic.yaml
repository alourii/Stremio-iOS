
# ملف codemagic.yaml

# تعيين إصدارات Xcode و iOS
xcode_version: 13.4.1
ios_version: 15.4

# تعيين معلومات التطبيق
app_name: stremio
app_scheme: .com.limvo.stremio

# تعيين بيئة البناء
build_environment:
  - MACOS_X_11.4

# تعريف المتغيرات
variables:
  # مسار مجلد العمل
  WORKSPACE_DIR: "${CM_BUILD_DIR}/${XCODE_WORKSPACE}"
  # مسار مجلد ملفات ipa
  IPA_DIR: "build/ios/ipa"
  # مسار ملفات سجلات Xcode
  LOGS_DIR: "/tmp/xcodebuild_logs"
  # مسار مجلد بيانات مشتقة من Xcode
  DERIVED_DATA_DIR: "$HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app"

# تعريف خطوات سير العمل
workflows:
  build-and-deploy:
    name: بناء ونشر التطبيق
    on:
      push:
        branches:
          - main
    steps:
      - checkout
      - xcode-select:
          version: "${XCODE_VERSION}"
      - install-xcode-build-tools
      - pod-install
      - cache-pod:
          paths:
            - "Pods"
      - xcode-build:
          workspace: "${WORKSPACE_DIR}"
          scheme: "${APP_SCHEME}"
          configuration: Release
          export_options:
            - EXPORT_PATH="$IPA_DIR"
            - EXPORT_TYPE="ipa"
      - archive-ios:
          workspace: "${WORKSPACE_DIR}"
          scheme: "${APP_SCHEME}"
          configuration: Release
          archive_path: "$IPA_DIR/${APP_NAME}.xcarchive"
      - upload-artifacts:
          paths:
            - "${IPA_DIR}/*.ipa"
            - "${LOGS_DIR}/*.log"
            - "${DERIVED_DATA_DIR}"
      - save-artifacts:
          path: "${IPA_DIR}/*.ipa"
          base_path: "ipa"
